<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AkÄ±llÄ± TarÄ±m - DanÄ±ÅŸman</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h2>AkÄ±llÄ± TarÄ±m DanÄ±ÅŸmanÄ±</h2>
        <a href="index.html" class="logout-btn">Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>

      <div class="chat-messages" id="chat-messages">
        <div class="message bot-message">
          <p>
            Merhaba! Ben AkÄ±llÄ± TarÄ±m AsistanÄ±. Bitkinizin yaprak fotoÄŸrafÄ±nÄ±
            analiz etmem iÃ§in lÃ¼tfen 'FotoÄŸraf YÃ¼kle' butonunu kullanÄ±n veya bir
            soru sorun.
          </p>
        </div>
      </div>

      <div class="chat-input-area">
        <input
          type="text"
          id="message-input"
          placeholder="Bir mesaj yazÄ±n..."
        />

        <button
          class="btn upload-btn"
          onclick="document.getElementById('file-input').click()"
        >
          ğŸ“· FotoÄŸraf YÃ¼kle
        </button>
        <input
          type="file"
          id="file-input"
          accept="image/*"
          style="display: none"
        />

        <button class="btn send-btn">GÃ¶nder</button>
      </div>
    </div>
    <script>
      // chat.html script kÄ±smÄ±nÄ±n EN BAÅINA ekle:
      const { createClient } = supabase;
      // Buraya kendi URL ve Key'ini tekrar yazmalÄ±sÄ±n veya global bir config dosyasÄ±ndan Ã§ekmelisin
      const _supabase = createClient(
        "https://sbhujxgjpduzwctekrkj.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNiaHVqeGdqcGR1endjdGVrcmtqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDY2OTUsImV4cCI6MjA3NzQyMjY5NX0.ikrDuarA7bbxHHgVboIdWuIuY-ilCXZH47ugNDtWqd4"
      );

      async function checkSession() {
        const {
          data: { session },
        } = await _supabase.auth.getSession();
        if (!session) {
          // Oturum yoksa giriÅŸ sayfasÄ±na at
          window.location.href = "index.html";
        }
      }
      checkSession();
      document.addEventListener("DOMContentLoaded", function () {
        // 1. Gerekli HTML elementlerini seÃ§
        const messageInput = document.getElementById("message-input"); // Mesaj yazma kutusu
        const sendButton = document.querySelector(".send-btn"); // GÃ¶nder butonu
        const chatMessages = document.getElementById("chat-messages"); // MesajlarÄ±n listelendiÄŸi alan

        // 2. "GÃ¶nder" butonuna tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
        sendButton.addEventListener("click", sendMessage);

        // 3. "Enter" tuÅŸuna basÄ±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
        messageInput.addEventListener("keydown", function (event) {
          // EÄŸer basÄ±lan tuÅŸ "Enter" ise (ve Shift'e basÄ±lmÄ±yorsa)
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); // Enter'Ä±n varsayÄ±lan "yeni satÄ±r" iÅŸlemini engelle
            sendMessage(); // MesajÄ± gÃ¶nder
          }
        });

        // 4. Ana Mesaj GÃ¶nderme Fonksiyonu
        function sendMessage() {
          const messageText = messageInput.value.trim(); // YazÄ±lan metni al, boÅŸluklarÄ± sil

          // EÄŸer kutu boÅŸ deÄŸilse...
          if (messageText !== "") {
            // a) KullanÄ±cÄ±nÄ±n mesajÄ±nÄ± ekrana bas
            appendMessage(messageText, "user-message");

            // b) Mesaj kutusunu temizle
            messageInput.value = "";

            // c) ArkadaÅŸlarÄ±nÄ±z hazÄ±r olduÄŸunda BU BÃ–LÃœMÃœ AÃ‡ACAÄIZ
            // sendToN8N(messageText);

            // d) ÅÄ°MDÄ°LÄ°K: Sahte bot cevabÄ± verelim (Mocking)
            simulateBotResponse();
          }
        }

        // 5. MesajlarÄ± Ekrana Basan YardÄ±mcÄ± Fonksiyon
        function appendMessage(text, messageClass) {
          // Yeni bir div oluÅŸtur
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("message", messageClass); // 'message' ve 'user-message'/'bot-message'

          // Ä°Ã§ine metni paragraf olarak ekle
          const paragraph = document.createElement("p");
          paragraph.textContent = text;
          messageDiv.appendChild(paragraph);

          // Ana mesaj alanÄ±na bu yeni div'i ekle
          chatMessages.appendChild(messageDiv);

          // Mesaj listesini en alta kaydÄ±r
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 6. Sahte Bot CevabÄ± Fonksiyonu (Mocking)
        function simulateBotResponse() {
          // "Bot yazÄ±yor..." mesajÄ± ekle (opsiyonel ama ÅŸÄ±k)
          const typingDiv = document.createElement("div");
          typingDiv.classList.add("message", "bot-message");
          typingDiv.id = "typing-indicator"; // Daha sonra silebilmek iÃ§in ID ver
          typingDiv.innerHTML = "<p>Bot yazÄ±yor...</p>";
          chatMessages.appendChild(typingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // 2 saniye sonra sahte bir cevap ver
          setTimeout(function () {
            // "Bot yazÄ±yor..." mesajÄ±nÄ± sil
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
              chatMessages.removeChild(typingIndicator);
            }

            // Sahte analiz sonucunu ekrana bas
            const botResponse =
              "Bu 'sahte' bir cevaptÄ±r. ArkadaÅŸÄ±nÄ±z Python modelini baÄŸladÄ±ÄŸÄ±nda burada gerÃ§ek analizi gÃ¶receksiniz. Ã–rnek: Bitkinizde 'Zeytin Yaprak Lekesi' tespit edildi.";
            appendMessage(botResponse, "bot-message");
          }, 2000); // 2000 milisaniye = 2 saniye
        }
      });
    </script>
  </body>
</html>
